zabbix_export:
  version: '7.0'
  template_groups:
    - uuid: 7df96b18c230490a9a0a9e2307226338
      name: Templates/NRPE
  templates:
    - uuid: cc1b895265d54f0291f59aecfee76b93
      template: 'NRPE Checks by Zabbix Proxy'
      name: XenServer NRPE Monitoring Template
      description: |
        Monitors XenServer/Citrix Hypervisor hosts via NRPE agent without requiring a Zabbix agent on the target.
        
        This template provides comprehensive monitoring including:
        - Host and Dom0 load averages (1min, 5min, 15min)
        - CPU and memory utilization
        - Disk usage monitoring
        - Service status (XAPI, multipath)
        - vGPU monitoring (if available)
        
        REQUIREMENTS:
        - Zabbix Proxy with external scripts installed
        - Target hosts must have NRPE agent configured
        - discover_xenapp_metrics.sh and query_xen_server.sh scripts on proxy
        - NRPE agent must allow connections from proxy
        - All monitoring commands must be defined in NRPE configuration
      groups:
        - name: XenServer Hosts
      items:
        - uuid: 4d3e3068ce3246b783b05be969b706bf
          name: NRPE Master Data Collection
          type: TRAP
          key: nrpe.master.data
          delay: '0'
          history: 7d
          value_type: TEXT
          trends: '0'
          triggers:
            - uuid: 18a504ff4c974039ac895e5a27563c39
              expression: 'nodata(/NRPE Checks by Zabbix Proxy/nrpe.master.data,10m)=1'
              name: 'NRPE Monitoring Agent is not responding on {HOST.NAME}'
              priority: HIGH
              description: |
                The master script query_xen_server.sh has not returned any data for the last 10 minutes.
                This indicates a problem with NRPE connectivity or the monitoring script.
                
                Possible Causes: 
                1. NRPE service is down on {HOST.NAME}
                2. Network connectivity issue between proxy and target
                3. Script execution error on the Zabbix proxy
                4. Firewall blocking port 5666
                
                Please check Latest Data for error details and verify NRPE connectivity
              manual_close: 'YES'
      discovery_rules:
        - uuid: 284ea349a4274c2d856df9eebe4c9bca
          name: XenServer Metrics Discovery
          type: TRAP
          key: xenapp.metrics.discovery
          delay: '0'
          lifetime_type: DELETE_NEVER
          lifetime: '0'
          enabled_lifetime_type: DISABLE_NEVER
          item_prototypes:
            - uuid: 95685406ec3440e6b37ac8a8dffd02a4
              name: '{#ZABBIX_KEY}'
              type: DEPENDENT
              key: 'nrpe.[{#ZABBIX_KEY}]'
              delay: '0'
              value_type: FLOAT
              units: '{#UNIT}'
              valuemap:
                name: 'Service state'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.[''{#ZABBIX_KEY}'']'
                - type: JAVASCRIPT
                  parameters:
                    - |
                      // Handle error messages and numeric values
                      if (value.match(/^(UNKNOWN|Check failed|CRITICAL|WARNING)/)) {
                          return value;  // Keep error message as-is for troubleshooting
                      }
                      // Parse numeric values
                      var num = parseFloat(value);
                      return isNaN(num) ? value : num.toString();
              master_item:
                key: nrpe.master.data
              trigger_prototypes:
                - uuid: 5b51bdafc7034de88726c87c4ae147b7
                  expression: 'last(/NRPE Checks by Zabbix Proxy/nrpe.[{#ZABBIX_KEY}]) > {$HIGH_THRESHOLD:"{#ZABBIX_KEY}"}'
                  name: '{#ZABBIX_KEY} is CRITICAL: {ITEM.LASTVALUE}{#UNIT} (threshold: {$HIGH_THRESHOLD:"{#ZABBIX_KEY}"})'
                  priority: HIGH
                  description: |
                    Critical threshold exceeded for {#ZABBIX_KEY} on {HOST.NAME}
                    
                    Current value: {ITEM.LASTVALUE}{#UNIT}
                    Critical threshold: {$HIGH_THRESHOLD:"{#ZABBIX_KEY}"}
                    
                    This indicates a serious performance issue that requires immediate attention.
                  manual_close: 'YES'
                - uuid: c4a931b456f545c98a4b1d8790535397
                  expression: 'last(/NRPE Checks by Zabbix Proxy/nrpe.[{#ZABBIX_KEY}]) > {$WARN_THRESHOLD:"{#ZABBIX_KEY}"}'
                  name: '{#ZABBIX_KEY} is WARNING: {ITEM.LASTVALUE}{#UNIT} (threshold: {$WARN_THRESHOLD:"{#ZABBIX_KEY}"})'
                  priority: AVERAGE
                  description: |
                    Warning threshold exceeded for {#ZABBIX_KEY} on {HOST.NAME}
                    
                    Current value: {ITEM.LASTVALUE}{#UNIT}
                    Warning threshold: {$WARN_THRESHOLD:"{#ZABBIX_KEY}"}
                    
                    Monitor this metric closely as it may indicate developing performance issues.
                  manual_close: 'YES'
                  dependencies:
                    - name: '{#ZABBIX_KEY} is CRITICAL: {ITEM.LASTVALUE}{#UNIT} (threshold: {$HIGH_THRESHOLD:"{#ZABBIX_KEY}"})'
                      expression: 'last(/NRPE Checks by Zabbix Proxy/nrpe.[{#ZABBIX_KEY}]) > {$HIGH_THRESHOLD:"{#ZABBIX_KEY}"}'
      macros:
        - macro: '{$HIGH_THRESHOLD}'
          value: '90'
          description: 'Default critical threshold for percentage-based metrics'
        - macro: '{$HIGH_THRESHOLD:"dom0.load.1min"}'
          value: '3.2'
          description: 'Dom0 1-minute load average critical threshold'
        - macro: '{$HIGH_THRESHOLD:"dom0.load.5min"}'
          value: '3.1'
          description: 'Dom0 5-minute load average critical threshold'
        - macro: '{$HIGH_THRESHOLD:"dom0.load.15min"}'
          value: '3.0'
          description: 'Dom0 15-minute load average critical threshold'
        - macro: '{$HIGH_THRESHOLD:"host.load.1min"}'
          value: '4'
          description: 'Host 1-minute load average critical threshold'
        - macro: '{$HIGH_THRESHOLD:"host.load.5min"}'
          value: '4'
          description: 'Host 5-minute load average critical threshold'
        - macro: '{$HIGH_THRESHOLD:"host.load.15min"}'
          value: '4'
          description: 'Host 15-minute load average critical threshold'
        - macro: '{$WARN_THRESHOLD}'
          value: '80'
          description: 'Default warning threshold for percentage-based metrics'
        - macro: '{$WARN_THRESHOLD:"dom0.load.1min"}'
          value: '2.7'
          description: 'Dom0 1-minute load average warning threshold'
        - macro: '{$WARN_THRESHOLD:"dom0.load.5min"}'
          value: '2.6'
          description: 'Dom0 5-minute load average warning threshold'
        - macro: '{$WARN_THRESHOLD:"dom0.load.15min"}'
          value: '2.5'
          description: 'Dom0 15-minute load average warning threshold'
        - macro: '{$WARN_THRESHOLD:"host.load.1min"}'
          value: '3'
          description: 'Host 1-minute load average warning threshold'
        - macro: '{$WARN_THRESHOLD:"host.load.5min"}'
          value: '3'
          description: 'Host 5-minute load average warning threshold'
        - macro: '{$WARN_THRESHOLD:"host.load.15min"}'
          value: '3'
          description: 'Host 15-minute load average warning threshold'
      valuemaps:
        - uuid: e74141ec729f4b9a93cffa2e47976762
          name: 'Service state'
          mappings:
            - value: '0'
              newvalue: Down
            - value: '1'
              newvalue: Up
